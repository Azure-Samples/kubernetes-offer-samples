**MICROSFOT CONFIDENTIAL** 

# Microsoft Defender: Vulnerability Pre-Scan Check  

### Overview
Vulnerability scanning is the process of discovering, analyzing, and reporting on security flaws and vulnerabilities. Vulnerability scans are conducted via automated vulnerability scanning tools to identify potential risk exposures. Here we use Microsoft Defender for Cloud and Qualys to identify vulnerabilities in your containers and use publicly available information from www.cve.org to assist in remediation. You can use other open source tools such as Twist Lock, Clair, and Aqua Security to pre-scan your image, however we use Microsoft Defender to complete the cert process so it is recommended that you use the same tool to ensure consistency. This doc will walk you through a pre-scan process using the Azure Portal/ Defender for your container registry to help speed the Azcert process down the line.  

Before beginning the pre-scan process, you will need to set up a Microsoft Azure Portal account to access Defender, if you don’t have an account already. Access to Defender is a paid resource. If you do not have an Azure portal account, you can create one at [Azure portal](https://portal.azure.com).

### Important Notes to Keep in Mind 
* CVEs are common vulnerabilities and exposures of publicly disclosed computer security flaws. During the pre-scan process you will use the CVE link to identify the vulnerability and remediate it.  
* Once your image is scanned, in the pop-up blade you will see a CVSS score and if this cvss 3.0 base score is >7 the image will be blocked until remediated. Below is a chart outlining the severity and score range of vulnerabilities.  

<p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/949fb0ac926aa16df4e3ec421a95a5f4960c7658/getting-started/images/cvss3.png" alt="cvss3" width="500"/>

### Vulnerability Pre-Scan Steps 
1. Sign into your Microsoft Azure Portal Account  

<p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/71c79359fb7b14e5936483559038abb057ceb95c/getting-started/images/step1-azureportal.png" alt="step1-azureportal" width="800"/>

2. In the search bar, enter container registries  

 <p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/71c79359fb7b14e5936483559038abb057ceb95c/getting-started/images/step2-search.png" alt="step2-search" width="800"/>

3. Select container registry that you have used to upload your application package (If you need help uploading the package please refer to here: [Prepare your Azure container technical assets for a Kubernetes application | Microsoft Learn](https://learn.microsoft.com/en-us/partner-center/marketplace/azure-container-technical-assets-kubernetes?tabs=windows) and the additional links at the end of this document). Once selected your view should look something like this: 
  
<p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/71c79359fb7b14e5936483559038abb057ceb95c/getting-started/images/step3-registry.png" alt="step3-registry" width="800"/>

4. On the left-hand side of the blade, locate “Microsoft Defender for Cloud” or on the top you can select “visit Microsoft Defender for Cloud”  

<p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/71c79359fb7b14e5936483559038abb057ceb95c/getting-started/images/step4-defender.png" alt="step4-defender" width="800"/>

5. You will see the Recommendations pop up under “description” below. Here is where you will be able to view each vulnerability.  

<p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/71c79359fb7b14e5936483559038abb057ceb95c/getting-started/images/step5-recommendations.png" alt="step5-recommendations" width="800"/>

6. You can select each description to view severity categories and begin remediating (you will also be able to see manual remediation steps as well) 

<p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/71c79359fb7b14e5936483559038abb057ceb95c/getting-started/images/step6-vulnerabilities.png" alt="step6-vulnerabilities" width="800"/>

   view if you expand “remediation steps”
 
<p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/71c79359fb7b14e5936483559038abb057ceb95c/getting-started/images/step6-remediationsteps.png" alt="step6-remediationsteps" width="800"/>

7. To see how to remediate each vulnerability, first click on the id and you will see a pop-up blade.   

<p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/71c79359fb7b14e5936483559038abb057ceb95c/getting-started/images/step7-eachvulnerability.png" alt="step7-eachvulnerability" width="800"/>

8. The pop-up blade shows the CVEs which will help you remediate the vulnerability!

<p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/71c79359fb7b14e5936483559038abb057ceb95c/getting-started/images/step8-CVEs.png" alt="step8-CVEs" width="800"/>

9. After clicking on the CVE link, you will be redirected to a page that shows you vulnerability details and remediation steps to take to mitigate it  

<p align="center"><img src="https://github.com/bobmital/kubernetes-offer-samples/blob/71c79359fb7b14e5936483559038abb057ceb95c/getting-started/images/step9-vulnerabilitydetails.png" alt="step9-vulnerabilitydetails" width="800"/>

10. After you remediate the vulnerabilities, reupload the image to the registry and review the vulnerability scan to ensure it has been mitigated.

### Additional helpful links to aid in building/deploying your container image

* [Azure Container Registry documentation | Microsoft Learn](https://learn.microsoft.com/en-us/azure/container-registry/)
* [Tutorial - Quick container image build - Azure Container Registry | Microsoft Learn](https://learn.microsoft.com/en-us/azure/container-registry/container-registry-tutorial-quick-task)
* [Prepare your Azure container technical assets for a Kubernetes application | Microsoft Learn](https://learn.microsoft.com/en-us/partner-center/marketplace/azure-container-technical-assets-kubernetes?tabs=windows)

 
